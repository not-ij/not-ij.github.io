<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Windows 11 Style New Tab</title>
  <style>
    :root {
      --accent: #2563eb;
      --taskbar-bg: rgba(15, 23, 42, 0.85);
      --window-bg: rgba(15, 23, 42, 0.9);
      --window-border: rgba(148, 163, 184, 0.5);
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --radius-lg: 18px;
      --radius-md: 12px;
      --shadow-soft: 0 18px 45px rgba(0, 0, 0, 0.4);
      --blur-strong: blur(24px);

      --wallpaper-image: url("https://4kwallpapers.com/images/walls/thumbs_3t/14423.jpg");
    }

    * {
      box-sizing: border-box;
      user-select: none;
    }

    body {
      margin: 0;
      height: 100vh;
      overflow: hidden;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: var(--text-main);
      background: #020617;
      display: flex;
      flex-direction: column;
      position: relative;
    }

    /* Wallpaper layer */
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      z-index: -1;
      background-image: var(--wallpaper-image);
      background-position: center center;
      background-repeat: no-repeat;
      background-color: #020617;
      background-size: cover;
      transition: background-image 0.25s ease-out, background-size 0.15s ease-out, background-color 0.15s ease-out;
    }

    /* Wallpaper mode variants */
    body[data-wallpaper-mode="fill"]::before {
      background-size: cover;
    }

    body[data-wallpaper-mode="fit"]::before {
      background-size: contain;
      background-color: #000000;
    }

    body[data-wallpaper-mode="center"]::before {
      background-size: auto;
      background-repeat: no-repeat;
      background-color: #000000;
    }

    /* Desktop area */
    .desktop {
      flex: 1;
      position: relative;
      padding: 24px;
    }

    .desktop-hint {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      color: var(--text-muted);
      font-size: 14px;
      pointer-events: none;
      text-shadow: 0 8px 18px rgba(0, 0, 0, 0.7);
    }

    .desktop-hint h1 {
      margin: 0 0 8px;
      font-weight: 500;
      letter-spacing: 0.03em;
    }

    /* Taskbar */
    .taskbar {
      position: relative;
      padding: 8px 0 12px;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .taskbar-inner {
      background: var(--taskbar-bg);
      backdrop-filter: var(--blur-strong);
      -webkit-backdrop-filter: var(--blur-strong);
      border-radius: 999px;
      box-shadow: var(--shadow-soft);
      padding: 6px 16px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border: 1px solid rgba(148, 163, 184, 0.25);
      max-width: min(80%, 720px);
    }

    .taskbar-left,
    .taskbar-center,
    .taskbar-right {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .taskbar-left {
      margin-right: 10px;
    }

    .taskbar-center {
      flex: 1;
      justify-content: center;
    }

    .taskbar-right {
      margin-left: 10px;
      font-size: 11px;
      color: var(--text-muted);
      white-space: nowrap;
    }

    .taskbar-btn {
      width: 32px;
      height: 32px;
      border-radius: 10px;
      border: none;
      padding: 0;
      background: transparent;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background 0.16s ease, transform 0.08s ease;
      color: #e5e7eb;
      font-size: 16px;
    }

    .taskbar-btn:hover {
      background: rgba(148, 163, 184, 0.2);
    }

    .taskbar-btn:active {
      transform: scale(0.96);
    }

    .taskbar-btn.start {
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid rgba(148, 163, 184, 0.6);
    }

    .taskbar-btn.start.active {
      outline: 2px solid rgba(59, 130, 246, 0.7);
      outline-offset: 1px;
    }

    /* Window base */
    .window {
      position: absolute;
      background: var(--window-bg);
      backdrop-filter: var(--blur-strong);
      -webkit-backdrop-filter: var(--blur-strong);
      border-radius: var(--radius-lg);
      border: 1px solid var(--window-border);
      box-shadow: var(--shadow-soft);
      color: var(--text-main);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      animation: windowIn 0.16s ease-out;
    }

    @keyframes windowIn {
      from {
        opacity: 0;
        transform: translateY(12px) scale(0.98);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .window-header {
      padding: 8px 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid rgba(30, 64, 175, 0.6);
      background: radial-gradient(circle at top left, rgba(37, 99, 235, 0.5), transparent);
    }

    .window-title {
      font-size: 13px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .window-title-icon {
      width: 16px;
      height: 16px;
      border-radius: 4px;
      background: rgba(37, 99, 235, 0.9);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
    }

    .window-controls {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .window-control {
      width: 22px;
      height: 18px;
      border-radius: 4px;
      border: none;
      background: transparent;
      color: var(--text-muted);
      font-size: 12px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0;
    }

    .window-control:hover {
      background: rgba(148, 163, 184, 0.2);
    }

    .window-control.close:hover {
      background: rgba(248, 113, 113, 0.28);
      color: #fecaca;
    }

    .window-body {
      padding: 10px 12px 12px;
      font-size: 13px;
    }

    /* Start menu positioning */
    .start-menu {
      width: 440px;
      height: 430px;
      left: 50%;
      transform: translateX(-50%);
      bottom: 72px;
    }

    .start-section-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.09em;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    .start-pinned-grid {
      display: grid;
      grid-template-columns: repeat(6, minmax(0, 1fr));
      gap: 8px 10px;
      margin-bottom: 10px;
    }

    .start-app {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      cursor: pointer;
      text-decoration: none;
      color: inherit;
      font-size: 11px;
    }

    .start-app-icon {
      width: 34px;
      height: 34px;
      border-radius: 9px;
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid rgba(148, 163, 184, 0.6);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }

    .start-app-label {
      max-width: 60px;
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: var(--text-muted);
    }

    .start-search {
      margin-bottom: 10px;
    }

    .start-search-input {
      width: 100%;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(51, 65, 85, 0.9);
      background: rgba(15, 23, 42, 0.95);
      color: var(--text-main);
      font-size: 12px;
      outline: none;
    }

    .start-search-input::placeholder {
      color: var(--text-muted);
    }

    .start-footer {
      margin-top: 6px;
      padding-top: 6px;
      border-top: 1px solid rgba(30, 64, 175, 0.6);
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
      color: var(--text-muted);
    }

    .start-user {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .user-avatar {
      width: 20px;
      height: 20px;
      border-radius: 999px;
      background: linear-gradient(135deg, #22c55e, #22d3ee);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 600;
      color: #0b1120;
    }

    .start-footer-right {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .link-muted {
      cursor: pointer;
      text-decoration: none;
      color: var(--text-muted);
    }

    .link-muted:hover {
      color: #e5e7eb;
    }

    /* Settings window */
    .settings-window {
      width: 460px;
      right: 32px;
      bottom: 100px;
    }

    .settings-grid {
      display: grid;
      grid-template-columns: 140px 1fr;
      gap: 12px;
    }

    .settings-nav {
      border-right: 1px solid rgba(30, 64, 175, 0.6);
      padding-right: 8px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .settings-nav-item {
      padding: 6px 8px;
      border-radius: 7px;
      cursor: pointer;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 6px;
      color: var(--text-muted);
    }

    .settings-nav-item.active {
      background: rgba(37, 99, 235, 0.22);
      color: #e5e7eb;
    }

    .settings-nav-indicator {
      width: 5px;
      height: 18px;
      border-radius: 999px;
      background: rgba(37, 99, 235, 0.85);
    }

    .settings-panel {
      font-size: 12px;
      display: none;
    }

    .settings-panel.active {
      display: block;
    }

    .settings-field {
      margin-bottom: 10px;
    }

    .settings-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .settings-chip-row {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .settings-chip {
      border-radius: 999px;
      border: 1px solid rgba(51, 65, 85, 0.9);
      padding: 4px 10px;
      font-size: 11px;
      cursor: pointer;
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-muted);
    }

    .settings-chip.active {
      border-color: rgba(37, 99, 235, 0.95);
      background: rgba(37, 99, 235, 0.18);
      color: #e5e7eb;
    }

    .settings-toggle-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .toggle-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      font-size: 12px;
    }

    .toggle-label {
      color: var(--text-muted);
    }

    .toggle-switch {
      width: 32px;
      height: 18px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid rgba(51, 65, 85, 0.9);
      padding: 1px;
      cursor: pointer;
      display: flex;
      align-items: center;
    }

    .toggle-knob {
      width: 14px;
      height: 14px;
      border-radius: 999px;
      background: #9ca3af;
      transition: transform 0.15s ease, background 0.15s ease;
    }

    .toggle-switch.active {
      background: rgba(37, 99, 235, 0.22);
      border-color: rgba(37, 99, 235, 0.95);
      justify-content: flex-end;
    }

    .toggle-switch.active .toggle-knob {
      background: #60a5fa;
    }

    .settings-select {
      width: 100%;
      padding: 4px 8px;
      border-radius: 7px;
      border: 1px solid rgba(51, 65, 85, 0.9);
      background: rgba(15, 23, 42, 0.95);
      color: var(--text-main);
      font-size: 11px;
      outline: none;
    }

    .settings-file-input {
      font-size: 11px;
      color: var(--text-muted);
    }

    .settings-file-input input[type="file"] {
      font-size: 11px;
      color: var(--text-main);
    }

    .settings-note {
      font-size: 11px;
      color: var(--text-muted);
    }

    /* Utility */
    .hidden {
      display: none !important;
    }
  </style>
</head>
<body data-wallpaper-mode="fill">
  <div class="desktop">
    <div class="desktop-hint">
      <h1>Windows‚Äëstyle New Tab</h1>
      <div>Click the Windows icon in the taskbar to open Start.</div>
      <div style="margin-top:4px;font-size:12px;opacity:0.8;">
        Open Settings to customize wallpaper, modes, Start apps, and taskbar apps.
      </div>
    </div>

    <!-- Start menu -->
    <div id="startMenu" class="window start-menu hidden">
      <div class="window-header">
        <div class="window-title">
          <div class="window-title-icon">‚äû</div>
          <span>Start</span>
        </div>
        <div class="window-controls">
          <button class="window-control close" data-close="startMenu">‚úï</button>
        </div>
      </div>
      <div class="window-body">
        <div class="start-search">
          <input class="start-search-input" placeholder="Type here to search (visual only)" />
        </div>

        <div class="start-section-label">Pinned</div>
        <div class="start-pinned-grid" id="startApps">
          <!-- Example apps ‚Äì URLs can be edited -->
          <a class="start-app start-app-toggle start-app-edge" href="https://www.google.com" target="_blank">
            <div class="start-app-icon" style="background:linear-gradient(135deg,#0ea5e9,#22c55e);">
              üåê
            </div>
            <div class="start-app-label">Browser</div>
          </a>
          <a class="start-app start-app-toggle start-app-youtube" href="https://www.youtube.com" target="_blank">
            <div class="start-app-icon" style="background:linear-gradient(135deg,#ef4444,#b91c1c);">
              ‚ñ∂
            </div>
            <div class="start-app-label">YouTube</div>
          </a>
          <a class="start-app start-app-toggle start-app-discord" href="https://discord.com/app" target="_blank">
            <div class="start-app-icon" style="background:linear-gradient(135deg,#6366f1,#4f46e5);">
              üí¨
            </div>
            <div class="start-app-label">Discord</div>
          </a>
          <a class="start-app start-app-toggle start-app-roblox" href="https://www.roblox.com" target="_blank">
            <div class="start-app-icon" style="background:linear-gradient(135deg,#0f172a,#111827);">
              ‚¨õ
            </div>
            <div class="start-app-label">Roblox</div>
          </a>
          <a class="start-app start-app-settings" href="javascript:void(0);">
            <div class="start-app-icon" style="background:linear-gradient(135deg,#0f172a,#111827);">
              ‚öô
            </div>
            <div class="start-app-label">Settings</div>
          </a>
          <a class="start-app start-app-toggle start-app-custom" href="https://github.com" target="_blank">
            <div class="start-app-icon" style="background:linear-gradient(135deg,#020617,#111827);">
              üß©
            </div>
            <div class="start-app-label">Custom</div>
          </a>
        </div>

        <div class="start-footer">
          <div class="start-user">
            <div id="userAvatar" class="user-avatar">U</div>
            <span id="userName">User</span>
            <a href="https://myaccount.google.com/" target="_blank"
               title="Google Account"
               style="margin-left:6px; color:var(--text-muted); text-decoration:none; font-size:14px;">
              ‚öô
            </a>
          </div>
          <div class="start-footer-right">
            <span class="link-muted">Power</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Settings window -->
    <div id="settingsWindow" class="window settings-window hidden">
      <div class="window-header">
        <div class="window-title">
          <div class="window-title-icon">‚öô</div>
          <span>Settings</span>
        </div>
        <div class="window-controls">
          <button class="window-control close" data-close="settingsWindow">‚úï</button>
        </div>
      </div>
      <div class="window-body">
        <div class="settings-grid">
          <div class="settings-nav">
            <div class="settings-nav-item active" data-settings-tab="appearance">
              <div class="settings-nav-indicator"></div>
              <span>Appearance</span>
            </div>
            <div class="settings-nav-item" data-settings-tab="startApps">
              <div style="width:5px;"></div>
              <span>Start apps</span>
            </div>
            <div class="settings-nav-item" data-settings-tab="taskbarApps">
              <div style="width:5px;"></div>
              <span>Taskbar apps</span>
            </div>
          </div>
          <div>
            <!-- Appearance panel -->
            <div class="settings-panel active" id="panel-appearance">
              <div class="settings-field">
                <div class="settings-label">Wallpaper</div>
                <div class="settings-chip-row">
                  <button class="settings-chip active" data-wallpaper="light">Light</button>
                  <button class="settings-chip" data-wallpaper="dark">Dark</button>
                  <button class="settings-chip" data-wallpaper="custom">Custom</button>
                </div>
              </div>
              <div class="settings-field">
                <div class="settings-label">Wallpaper mode</div>
                <select id="wallpaperModeSelect" class="settings-select">
                  <option value="fill">Fill (cover screen)</option>
                  <option value="fit">Fit (no cropping)</option>
                  <option value="center">Center (no scaling)</option>
                </select>
              </div>
              <div class="settings-field" id="customWallpaperField">
                <div class="settings-label">Custom wallpaper</div>
                <div class="settings-file-input">
                  <input id="wallpaperFileInput" type="file" accept="image/*" />
                </div>
                <div class="settings-note" id="customWallpaperNote">
                  Choose an image to use as your wallpaper. It will be saved locally in this browser.
                </div>
              </div>
              <div class="settings-note">
                When we convert this into a full Chrome extension, we can sync these settings and hook real profile data.
              </div>
            </div>

            <!-- Start apps panel -->
            <div class="settings-panel" id="panel-startApps">
              <div class="settings-field">
                <div class="settings-label">Pinned apps</div>
                <div class="settings-toggle-list">
                  <div class="toggle-row">
                    <span class="toggle-label">Browser</span>
                    <div class="toggle-switch active" data-toggle-target="start-app-edge">
                      <div class="toggle-knob"></div>
                    </div>
                  </div>
                  <div class="toggle-row">
                    <span class="toggle-label">YouTube</span>
                    <div class="toggle-switch active" data-toggle-target="start-app-youtube">
                      <div class="toggle-knob"></div>
                    </div>
                  </div>
                  <div class="toggle-row">
                    <span class="toggle-label">Discord</span>
                    <div class="toggle-switch active" data-toggle-target="start-app-discord">
                      <div class="toggle-knob"></div>
                    </div>
                  </div>
                  <div class="toggle-row">
                    <span class="toggle-label">Roblox</span>
                    <div class="toggle-switch active" data-toggle-target="start-app-roblox">
                      <div class="toggle-knob"></div>
                    </div>
                  </div>
                  <div class="toggle-row">
                    <span class="toggle-label">Custom</span>
                    <div class="toggle-switch active" data-toggle-target="start-app-custom">
                      <div class="toggle-knob"></div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="settings-note">
                Later we can make this dynamic with custom app names, icons, and URLs from a config UI.
              </div>
            </div>

            <!-- Taskbar apps panel -->
            <div class="settings-panel" id="panel-taskbarApps">
              <div class="settings-field">
                <div class="settings-label">Taskbar apps</div>
                <div class="settings-toggle-list">
                  <div class="toggle-row">
                    <span class="toggle-label">Browser</span>
                    <div class="toggle-switch active" data-toggle-target="taskbar-app-browser">
                      <div class="toggle-knob"></div>
                    </div>
                  </div>
                  <div class="toggle-row">
                    <span class="toggle-label">Discord</span>
                    <div class="toggle-switch active" data-toggle-target="taskbar-app-discord">
                      <div class="toggle-knob"></div>
                    </div>
                  </div>
                  <div class="toggle-row">
                    <span class="toggle-label">Settings</span>
                    <div class="toggle-switch active" data-toggle-target="taskbar-app-settings">
                      <div class="toggle-knob"></div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="settings-note">
                Taskbar layout can also be extended with profiles, workspaces, or game modes later.
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- Taskbar -->
  <div class="taskbar">
    <div class="taskbar-inner">
      <div class="taskbar-left">
        <!-- Start button -->
        <button id="startButton" class="taskbar-btn start" title="Start">
          <svg width="18" height="18" viewBox="0 0 20 20" aria-hidden="true">
            <rect x="1" y="1" width="8" height="8" fill="#60a5fa"></rect>
            <rect x="11" y="1" width="8" height="8" fill="#3b82f6"></rect>
            <rect x="1" y="11" width="8" height="8" fill="#1d4ed8"></rect>
            <rect x="11" y="11" width="8" height="8" fill="#1e3a8a"></rect>
          </svg>
        </button>
      </div>

      <div class="taskbar-center" id="taskbarCenterApps">
        <button class="taskbar-btn taskbar-app taskbar-app-browser" title="Browser">
          üåê
        </button>
        <button class="taskbar-btn taskbar-app taskbar-app-discord" title="Discord">
          üí¨
        </button>
        <button class="taskbar-btn taskbar-app taskbar-app-settings" title="Settings">
          ‚öô
        </button>
      </div>

      <div class="taskbar-right">
        <span id="taskbarTime"></span>
      </div>
    </div>
  </div>

  <script>
    // ---- Time in taskbar ----
    function updateTime() {
      const el = document.getElementById('taskbarTime');
      if (!el) return;
      const now = new Date();
      const optionsTime = { hour: '2-digit', minute: '2-digit' };
      const optionsDate = { day: '2-digit', month: '2-digit', year: '2-digit' };
      const timeStr = now.toLocaleTimeString([], optionsTime);
      const dateStr = now.toLocaleDateString([], optionsDate);
      el.textContent = timeStr + '  ' + dateStr;
    }
    updateTime();
    setInterval(updateTime, 30000);

    // ---- Basic elements ----
    const startButton = document.getElementById('startButton');
    const startMenu = document.getElementById('startMenu');
    const settingsWindow = document.getElementById('settingsWindow');
    const body = document.body;

    // ---- Start menu toggle ----
    function toggleStartMenu(forceState) {
      const isHidden = startMenu.classList.contains('hidden');
      const shouldShow = (forceState === undefined) ? isHidden : forceState;
      if (shouldShow) {
        startMenu.classList.remove('hidden');
        startButton.classList.add('active');
      } else {
        startMenu.classList.add('hidden');
        startButton.classList.remove('active');
      }
    }

    startButton.addEventListener('click', () => {
      toggleStartMenu();
    });

    // ---- Close buttons for windows ----
    document.querySelectorAll('.window-control.close').forEach(btn => {
      btn.addEventListener('click', () => {
        const targetId = btn.getAttribute('data-close');
        const win = document.getElementById(targetId);
        if (win) win.classList.add('hidden');
        if (targetId === 'startMenu') startButton.classList.remove('active');
      });
    });

    // ---- Settings open from Start and taskbar ----
    document.querySelectorAll('.start-app-settings').forEach(el => {
      el.addEventListener('click', () => {
        settingsWindow.classList.remove('hidden');
      });
    });
    document.querySelector('.taskbar-app-settings').addEventListener('click', () => {
      settingsWindow.classList.remove('hidden');
    });

    // ---- Taskbar app behavior ----
    document.querySelector('.taskbar-app-browser').addEventListener('click', () => {
      window.open('https://www.google.com', '_blank');
    });
    document.querySelector('.taskbar-app-discord').addEventListener('click', () => {
      window.open('https://discord.com/app', '_blank');
    });

    // ---- Close Start when clicking outside ----
    document.addEventListener('click', (e) => {
      const clickInsideStart = startMenu.contains(e.target) || startButton.contains(e.target);
      const clickInsideSettings = settingsWindow.contains(e.target);
      const clickInTaskbar = e.target.closest('.taskbar-inner');
      if (!clickInsideStart && !clickInsideSettings && !clickInTaskbar) {
        toggleStartMenu(false);
      }
    });

    // ---- Settings navigation ----
    document.querySelectorAll('.settings-nav-item').forEach(item => {
      item.addEventListener('click', () => {
        const tab = item.getAttribute('data-settings-tab');
        document.querySelectorAll('.settings-nav-item').forEach(i => i.classList.remove('active'));
        item.classList.add('active');
        document.querySelectorAll('.settings-panel').forEach(panel => panel.classList.remove('active'));
        const panel = document.getElementById('panel-' + tab);
        if (panel) panel.classList.add('active');
      });
    });

    // ---- Username & avatar (placeholder for now) ----
    function getPseudoUserName() {
      // Placeholder logic for standalone HTML.
      // When this becomes a Chrome extension, replace with:
      // chrome.identity.getProfileUserInfo(info => { ... });
      const nameFromNavigator = navigator.userAgentData?.platform || navigator.platform || "User";
      const trimmed = nameFromNavigator.toString().trim();
      if (!trimmed || trimmed.length === 0) return "User";
      return trimmed;
    }

    function updateUserDisplay() {
      const name = getPseudoUserName();
      const firstLetter = name.charAt(0).toUpperCase();
      const userNameEl = document.getElementById("userName");
      const userAvatarEl = document.getElementById("userAvatar");
      if (userNameEl) userNameEl.textContent = name;
      if (userAvatarEl) userAvatarEl.textContent = firstLetter;
    }
    updateUserDisplay();

    // ---- Wallpaper system ----
    const WALL_LIGHT_URL = "https://4kwallpapers.com/images/walls/thumbs_3t/14423.jpg";
    const WALL_DARK_URL = "https://4kwallpapers.com/images/walls/thumbs_3t/14430.jpg";

    const WALL_KEY_TYPE = "winTabWallpaperType";
    const WALL_KEY_MODE = "winTabWallpaperMode";
    const WALL_KEY_CUSTOM = "winTabWallpaperCustom";

    const wallpaperChips = document.querySelectorAll('.settings-chip[data-wallpaper]');
    const wallpaperModeSelect = document.getElementById('wallpaperModeSelect');
    const wallpaperFileInput = document.getElementById('wallpaperFileInput');
    const customWallpaperField = document.getElementById('customWallpaperField');
    const customWallpaperNote = document.getElementById('customWallpaperNote');

    function applyWallpaper(type, mode, customDataUrl) {
      // Type: "light" | "dark" | "custom"
      let url = WALL_LIGHT_URL;
      if (type === "dark") url = WALL_DARK_URL;
      if (type === "custom" && customDataUrl) url = customDataUrl;

      document.documentElement.style.setProperty('--wallpaper-image', 'url("' + url + '")');

      const normalizedMode = mode || "fill";
      body.setAttribute('data-wallpaper-mode', normalizedMode);

      wallpaperChips.forEach(chip => {
        const chipType = chip.getAttribute('data-wallpaper');
        chip.classList.toggle('active', chipType === type);
      });

      if (type === "custom") {
        customWallpaperField.classList.remove('hidden');
        if (!customDataUrl) {
          customWallpaperNote.textContent = "No custom wallpaper yet. Choose an image to upload.";
        } else {
          customWallpaperNote.textContent = "Custom wallpaper set. Upload again to replace it.";
        }
      } else {
        customWallpaperField.classList.add('hidden');
      }

      if (wallpaperModeSelect) wallpaperModeSelect.value = normalizedMode;
    }

    function loadWallpaperSettings() {
      const savedType = localStorage.getItem(WALL_KEY_TYPE) || "light";
      const savedMode = localStorage.getItem(WALL_KEY_MODE) || "fill";
      const savedCustom = localStorage.getItem(WALL_KEY_CUSTOM) || "";

      applyWallpaper(savedType, savedMode, savedCustom || null);
    }

    function saveWallpaperSettings(type, mode, customDataUrl) {
      if (type) localStorage.setItem(WALL_KEY_TYPE, type);
      if (mode) localStorage.setItem(WALL_KEY_MODE, mode);
      if (typeof customDataUrl === "string") {
        localStorage.setItem(WALL_KEY_CUSTOM, customDataUrl);
      }
    }

    // Wallpaper type selection
    wallpaperChips.forEach(chip => {
      chip.addEventListener('click', () => {
        const type = chip.getAttribute('data-wallpaper');
        const currentMode = body.getAttribute('data-wallpaper-mode') || "fill";
        const customDataUrl = localStorage.getItem(WALL_KEY_CUSTOM) || "";
        applyWallpaper(type, currentMode, customDataUrl || null);
        saveWallpaperSettings(type, currentMode, undefined);
      });
    });

    // Wallpaper mode selection
    if (wallpaperModeSelect) {
      wallpaperModeSelect.addEventListener('change', () => {
        const mode = wallpaperModeSelect.value;
        const type = localStorage.getItem(WALL_KEY_TYPE) || "light";
        const customDataUrl = localStorage.getItem(WALL_KEY_CUSTOM) || "";
        applyWallpaper(type, mode, customDataUrl || null);
        saveWallpaperSettings(type, mode, undefined);
      });
    }

    // Custom wallpaper upload
    if (wallpaperFileInput) {
      wallpaperFileInput.addEventListener('change', () => {
        const file = wallpaperFileInput.files && wallpaperFileInput.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
          const dataUrl = e.target.result;
          const mode = wallpaperModeSelect.value || "fill";
          applyWallpaper("custom", mode, dataUrl);
          saveWallpaperSettings("custom", mode, dataUrl);
        };
        reader.readAsDataURL(file);
      });
    }

    // ---- Start apps and taskbar apps toggles ----
    document.querySelectorAll('.toggle-switch[data-toggle-target]').forEach(toggle => {
      toggle.addEventListener('click', () => {
        toggle.classList.toggle('active');
        const targetClass = toggle.getAttribute('data-toggle-target');
        const isActive = toggle.classList.contains('active');
        document.querySelectorAll('.' + targetClass).forEach(el => {
          el.classList.toggle('hidden', !isActive);
        });
      });
    });

    function syncTogglesOnLoad() {
      document.querySelectorAll('.toggle-switch[data-toggle-target]').forEach(toggle => {
        const targetClass = toggle.getAttribute('data-toggle-target');
        const isActive = toggle.classList.contains('active');
        document.querySelectorAll('.' + targetClass).forEach(el => {
          el.classList.toggle('hidden', !isActive);
        });
      });
    }

    // ---- Initial boot ----
    loadWallpaperSettings();
    syncTogglesOnLoad();
  </script>
</body>
</html>
